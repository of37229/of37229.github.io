<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <title id ="Title">Comments</title>
    <link rel="icon" type="image/x-icon" href="https://dglight.neocities.org/assets/images/edited-neocities.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A tool I made for displaying comments people have left for stuff I have on my website, dglight.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="" id="style">
    <link rel="stylesheet" href="comments.css" id="style-static">
    <script src="https://dglight.neocities.org/scripts/styler.js" defer></script>
  </head>

  <body id="comments-body">
    <header>
      <div class="container-line">
        <h4>Comments</h4>
      </div>
    </header>

    <main >
      <script>
        function toggleHidden(element){
          //console.log("toggling " + element + " hidden.");
          element.classList.toggle("hidden");
        }
        function insertLink(textContent){
          insertedStr = "[lnk:link text:example.com]";
          if (textContent.value.length + insertedStr.length > 1000){
            alert("Not enough room");
            console.log("Error - not enough room to insert linktext", "=>", textContent.value, textContent.value.length + "chars");
            return;
          }
          textContent.value += insertedStr;
        }
        function insertImage(textContent){
          insertedStr = "[img:example.com/image.png]";
          if (textContent.value.length + insertedStr.length > 1000){
            alert("Not enough room");
            console.log("Error - not enough room to insert imagetext", "=>", textContent.value, textContent.value.length + "chars");
            return;
          }
          textContent.value += insertedStr;
        }
        function insertReply(textContent, uid){
          insertedStr = "@" + uid.toString();
          //console.log(textContent);
          if (textContent.value.length + insertedStr.length > 1000){
            alert("Not enough room");
            console.log("Error - not enough room to insert reply text", "=>", textContent.value, textContent.value.length + "chars");
            return;
          }
          textContent.value += insertedStr;
        }
      </script>

      <div id="index" style="width:100%">
        <div id="index-dumpline"></div>

        <div id="index-newcomment-container" class="hidden">
          <form class="Comment-Form" id="index-form">
            <textarea class="comment-textarea" placeholder="Leave a nice comment!" maxlength="1000" required></textarea>
            <input type="text" class="DisplayName" placeholder="Optional DisplayName" maxlength="25">
            <button type="button" class="form-button" onclick="insertLink(this.parentElement.firstElementChild);">
              <img src="assets/link.svg" alt="Add link">
            </button>
            <button type="button" class="form-button" onclick="insertImage(this.parentElement.firstElementChild);">
              <img src="assets/img.svg" alt="Add image">
            </button>
            <button class="comment-btn" type="submit">Post</button>
          </form>
        </div>

      </div>



      <div id="uglycry" style="width:100%">
        <div id="uglycry-dumpline"></div>

        <div id="uglycry-newcomment-container" class="hidden">
          <form class="Comment-Form" id="uglycry-form">
            <textarea class="comment-textarea" placeholder="Leave a nice comment!" maxlength="1000" required></textarea>
            <input type="text" class="DisplayName" placeholder="Optional DisplayName" maxlength="25">
            <button type="button" class="form-button" onclick="insertLink(this.parentElement.firstElementChild);">
              <img src="assets/link.svg" alt="Add link">
            </button>
            <button type="button" class="form-button" onclick="insertImage(this.parentElement.firstElementChild);">
              <img src="assets/img.svg" alt="Add image">
            </button>
            <button class="comment-btn" type="submit">Post</button>
          </form>
        </div>

      </div>



      <div id="ashenvillage" style="width:100%">
        <div id="ashenvillage-dumpline"></div>

        <div id="ashenvillage-newcomment-container" class="hidden">
          <form class="Comment-Form" id="ashenvillage-form">
            <textarea class="comment-textarea" placeholder="Leave a nice comment!" maxlength="1000" required></textarea>
            <input type="text" class="DisplayName" placeholder="Optional DisplayName" maxlength="25">
            <button type="button" class="form-button" onclick="insertLink(this.parentElement.firstElementChild);">
              <img src="assets/link.svg" alt="Add link">
            </button>
            <button type="button" class="form-button" onclick="insertImage(this.parentElement.firstElementChild);">
              <img src="assets/img.svg" alt="Add image">
            </button>
            <button class="comment-btn" type="submit">Post</button>
          </form>
        </div>

      </div>



      <div id="openhexagon" style="width:100%">
        <div id="openhexagon-dumpline"></div>

        <div id="openhexagon-newcomment-container" class="hidden">
          <form class="Comment-Form" id="openhexagon-form">
            <textarea class="comment-textarea" placeholder="Leave a nice comment!" maxlength="1000" required></textarea>
            <input type="text" class="DisplayName" placeholder="Optional DisplayName" maxlength="25">
            <button type="button" class="form-button" onclick="insertLink(this.parentElement.firstElementChild);">
              <img src="assets/link.svg" alt="Add link">
            </button>
            <button type="button" class="form-button" onclick="insertImage(this.parentElement.firstElementChild);">
              <img src="assets/img.svg" alt="Add image">
            </button>
            <button class="comment-btn" type="submit">Post</button>
          </form>
        </div>

      </div>



      <div id="cyberpunkalleyway" style="width:100%">
        <div id="cyberpunkalleyway-dumpline"></div>

        <div id="cyberpunkalleyway-newcomment-container" class="hidden">
          <form class="Comment-Form" id="cyberpunkalleyway-form">
            <textarea class="comment-textarea" placeholder="Leave a nice comment!" maxlength="1000" required></textarea>
            <input type="text" class="DisplayName" placeholder="Optional DisplayName" maxlength="25">
            <button type="button" class="form-button" onclick="insertLink(this.parentElement.firstElementChild);">
              <img src="assets/link.svg" alt="Add link">
            </button>
            <button type="button" class="form-button" onclick="insertImage(this.parentElement.firstElementChild);">
              <img src="assets/img.svg" alt="Add image">
            </button>
            <button class="comment-btn" type="submit">Post</button>
          </form>
        </div>

      </div>



    <script type="module">
      // IMPORTS AND REQS
      import { initializeApp} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";

      import { getFirestore, collection, getCountFromServer, query, limit, orderBy, startAt, getDocs, getDoc, setDoc, doc, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyANZIQHRlE_IJgd5SByveUUAjDkOQo1CKo",
        authDomain: "dglight-comments.firebaseapp.com",
        projectId: "dglight-comments",
        storageBucket: "dglight-comments.firebasestorage.app",
        messagingSenderId: "989971996321",
        appId: "1:989971996321:web:520d042a6b0b3a2950dae0"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      //Document referrers
      const section = location.hash.replace("#", "") || "index";
      const superElement = document.getElementById(section);
      const formElement = document.getElementById(section + "-form");
      const newCommentButton = document.getElementById("newcomment-btn-" + section);
      const newCommentContainer = document.getElementById(section + "-newcomment-container");

      // Helpers
      async function encodeToId(str, map, len){
        const enc = new TextEncoder();
        const data = enc.encode(len + '||' + str);
        const hashBuf = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuf));
        const hashHex = hashArray.map(b => b.toString(map).padStart(2,'0')).join('').substring(0, len);
        return hashHex;
      }
      function parseCommentText(text) {
        let out = text
          .replace(/\[img:(.*?)\]/g, `<img class="comment-image" src="$1" alt="">`)
          .replace(/\[lnk:(.*?)\]/g, (match, inner) => {
            const parts = inner.split(":");
            if (parts.length >= 2) {
              const label = parts[0];
              const url = parts.slice(1).join(":");
              return `<a class="comment-link" href="https://${url}" target="_blank">${label}</a>`;
            }
            return match;
          });

        return out;
      }
      async function doWork(subject){
        let id = await getClientId();
        const offset = Math.floor(Math.random(id) * 10);
        //console.log(offset);
        let res = subject;
        for (let i = 0; i < 25 + offset; i++){
          const newres = await encodeToId(res, 36, 23);
          res = newres;
        }
        return res;
      }
      function getReplyReference(string){
        const startInd = string.indexOf("@") + 1;
        if (startInd === -1) { return ""; }
        return string.substring(startInd, startInd + 6);
      }

      // Testing and error handling
      async function testRead(place) {
        const snapshot = await getDocs(collection(db, place));
        snapshot.forEach(doc =>
          console.log(doc.id, "=>", doc.data(), parseCommentText(doc.data().comtext))
        );
      }

      // Fingerprint the session - should I know you?
      async function getClientId() {
        const key = 'dglight-sitewide:clientId';
        let id = localStorage.getItem(key);
        if (id) { return id; }

        // light fingerprint: userAgent + screen size + languages (nothing revealing, don't yall worry)
        const fp = [
          navigator.userAgent || '',
          `${screen.width}x${screen.height}`,
          (navigator.languages || []).join(',')
        ].join('||');;

        const hashHex = await encodeToId(fp, 36, 4);

        id = hashHex; // persistent hashed client id
        localStorage.setItem(key, id);
        return id;
      }

      // NEW SUBMISSION FUNCTION
      async function newSubmission(){
        const textContent = formElement.firstElementChild;
        const text = textContent.value;
        const reply = getReplyReference(text);
        const work = await doWork(document.querySelector("meta[name='description']")?.content);
        if(textContent.validity.valid != true){
          alert("Comment Invalid");
          console.log("Error - text not valid", "=>", textContent.validity);
          return;
        }else{
          formElement.firstElementChild.value = "Posting...";
        }
        const messageId = await encodeToId(text, 36, 6);
        const userId = await getClientId();
        let displayName = formElement.querySelector(".DisplayName").value;
        if(displayName.length == 0){
          formElement.firstElementChild.value = "Display name empty. Posing as 'Anonymous'...";
          displayName = "Anonymous";
        }

        const newProposal = {
          comtext: text.toString(),
          disp: displayName.toString(),
          repto: reply.toString(),
          up: Math.floor(0),
          user: userId.toString(),
          work: work.toString(),
        }

        //console.log("New comment proposal:", superElement.id, "=>" , newProposal);
        const docRef = doc(db, superElement.id, messageId.toString());

        //return;

        try {
          await setDoc(docRef, newProposal);
          console.log("New comment posted! :)");
        } catch (err) {
          console.error("Error creating branch:", err);
          alert("Error posting comment â€” try again or contact Derek. Do not spam.");
        }
      }

      // CREATE COMMENT FUNCTION
      function createComment(id, data) {
        const wrapper = document.createElement("div");
        wrapper.className = "comment";
        wrapper.id = "comment-" + id;

        const top = document.createElement("div");
        top.className = "comment-header";
        top.innerHTML = `<span class="comment-name">"${data.disp || "Anonymous"}"(#${data.user}) posted comment</span>`;

        const replyBtn = document.createElement("button");
        replyBtn.className = "reply-btn";
        replyBtn.id = "reply-btn-" + id;
        replyBtn.textContent = "@" + id;
        replyBtn.title = "Click here to reply"
        replyBtn.onclick = function(event) {
          insertReply(superElement.querySelector("textarea"), id);
        };

        top.appendChild(replyBtn);

        const body = document.createElement("div");
        body.className = "comment-body";
        body.innerHTML = parseCommentText(data.comtext);

        const replies = document.createElement("div");
        replies.className = "replies";

        wrapper.appendChild(top);
        wrapper.appendChild(body);
        wrapper.appendChild(replies);

        return wrapper;
      }

      // READ COMMENT FUNCTION
      async function readComments(sectionId) {
        const dumpline = document.getElementById(sectionId + "-dumpline");
        if (!dumpline) {console.warn("No location declared to display comments at for this page yet (safety measure) this page is likely still under construction."); return;}
        const snapshot = await getDocs(collection(db, sectionId));

        //console.log("Found comment referrers. Loading comments...");
        // load into list
        const comments = [];
        snapshot.forEach(doc => { comments.push({ id: doc.id,...doc.data() }); });
        comments.sort((a, b) => b.up - a.up); // Sort by up [TODO - MAKE UPs lol]

        // map to sorted list
        const nodeMap = new Map();
        comments.forEach(comm => {
          nodeMap.set(comm.id, createComment(comm.id, comm));
        });

        // actual creation part
        const container = document.createElement("div");
        container.className = "comment-thread";
        // Attach nodes with reply subsorting
        comments.forEach(comm => {
          const node = nodeMap.get(comm.id);
          if (comm.repto && nodeMap.has(comm.repto)) {
            const parent = nodeMap.get(comm.repto);
            parent.querySelector(".replies").appendChild(node);
          } else {
            container.appendChild(node); //99% will go here
          }
        });

        dumpline.after(container);
      }

      // NEW SUBMISSION LISTENERS
      formElement.addEventListener("submit", async (e) => {
        e.preventDefault();
        const textAreaElm = formElement.firstElementChild;

        await newSubmission();
        textAreaElm.value = "";
        location.reload();
      });


      // CONTENT LISTENER
      document.addEventListener("DOMContentLoaded", () => {
        if (!section) return;
        readComments(section);
        toggleHidden(newCommentContainer);
        const textAreaElm = formElement.firstElementChild;
        if (textAreaElm.value.length > 0) textAreaElm.value = "";
      });

    </script>

    </main>

  </body>
</html>
